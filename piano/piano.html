<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>piano</title>
    <style>
        html, body{/*피아노 배경색 검정*/
            margin:0px;
            background-color: black;
        }
        div{/*흰 건반 위 검은건반을 위한 절대배치*/
            display: inline-block;
            position: absolute;
        }
        .white-keys { z-index: 1; }/*흰건반 젤아래*/
        .black-keys { z-index: 2; }/*검은건반 흰건반 위*/
        .piano {
            width: 855px; /*피아노 전체크기 제한*/
            height: 395px;
            overflow: hidden; /*영역 넘어가면 자름*/
            position: relative;/*자식 absolute 요소의 기준으로 사용됨*/
        }
        .key{
            transition: filter 0.2s, box-shadow 0.2s;/*마우스올릴때 부드러운호과*/
            cursor: pointer;/*마우스올리면 커서변경*/
            position: relative;
        }
        .key:active {/*마우스클릭할때 그림자*/
            filter: brightness(1.2);
            filter: drop-shadow(0 0 10px red);
            z-index: 3;/*클릭시 z-index 증가*/
        }
        .key.active{/*키보드 연주할 때 그림자*/
            filter: brightness(1.2);
            filter: drop-shadow(0 0 10px red);
            z-index: 3; /*키보드 입력 시 z-index 증가*/
        }
    </style>
</head>
<body>
    <div class="piano">
        <div class="white-keys"><!--흰 건반, 도,레,미 건반을 이용해 복붙 후 위치조정-->
            <div class="div_key" style="left: 0px;">
                <img src="piano_C.jpg" class="key" data-note='F_low'>
                <!--onclick속성을 통해 함수 실행 > 클릭 시 해당 음악재생되도록-->
            </div>
            <div class="div_key" style="left: 50px;">
                <img src="piano_D.jpg" class="key" data-note='G_low'>
            </div>
            <div class="div_key" style="left: 100px;">
                <img src="piano_D.jpg" class="key" data-note='A_low'>
            </div>
            <div class="div_key" style="left: 150px;">
                <img src="piano_E.jpg" class="key" data-note='B_low'>
            </div>
            <div class="div_key" style="left: 200px;">
                <img src="piano_C.jpg" class="key" data-note='C_middle'>
            </div>
            <div class="div_key" style="left: 250px;">
                <img src="piano_D.jpg" class="key" data-note='D_middle'>
            </div>
            <div class="div_key" style="left: 300px;">
                <img src="piano_E.jpg" class="key" data-note='E_middle'>
            </div>
            <div class="div_key" style="left: 350px;">
                <img src="piano_C.jpg" class="key" data-note='F_middle'>
            </div>
            <div class="div_key" style="left: 400px;">
                <img src="piano_D.jpg" class="key" data-note='G_middle'>
            </div>
            <div class="div_key" style="left: 450px;">
                <img src="piano_D.jpg" class="key" data-note='A_middle'>
            </div>
            <div class="div_key" style="left: 500px;">
                <img src="piano_E.jpg" class="key" data-note='B_middle'>
            </div>
            <div class="div_key" style="left: 550px;">
                <img src="piano_C.jpg" class="key" data-note='C_high'>
            </div>
            <div class="div_key" style="left: 600px;">
                <img src="piano_D.jpg" class="key" data-note='D_high'>
            </div>
            <div class="div_key" style="left: 650px;">
                <img src="piano_E.jpg" class="key" data-note='E_high'>
            </div>
            <div class="div_key" style="left: 700px;">
                <img src="piano_C.jpg" class="key" data-note='F_high'>
            </div>
            <div class="div_key" style="left: 750px;">
                <img src="piano_D.jpg" class="key" data-note='G_high'>
            </div>
            <div class="div_key" style="left: 800px;">
                <img src="piano_D.jpg" class="key" data-note='A_high'>
            </div>
        </div>
      
        <div class="black-keys"><!--검은건반, 레플렛 미플렛 이용해 복붙 후 위치조정-->
            <div class="div_key" style="left: 35px;">
                <img src="piano_Db.jpg" class="key" data-note='Gb_low'>
            </div>
            <div class="div_key" style="left: 85px;">
                <img src="piano_Db.jpg" class="key" data-note='Ab_low'>
            </div>
            <div class="div_key" style="left: 137px;">
                <img src="piano_Eb.jpg" class="key" data-note='Bb_low'>
            </div>
            <div class="div_key" style="left: 235px;">
                <img src="piano_Db.jpg" class="key" data-note='Db_middle'>
            </div>
            <div class="div_key" style="left: 287px;">
                <img src="piano_Eb.jpg" class="key" data-note='Eb_middle'>
            </div>
            <div class="div_key" style="left: 385px;">
                <img src="piano_Db.jpg" class="key" data-note='Gb_middle'>
            </div>
            <div class="div_key" style="left: 435px;">
                <img src="piano_Db.jpg" class="key" data-note='Ab_middle'>
            </div>
            <div class="div_key" style="left: 487px;">
                <img src="piano_Eb.jpg" class="key" data-note='Bb_middle'>
            </div>
            <div class="div_key" style="left: 585px;">
                <img src="piano_Db.jpg" class="key" data-note='Db_high'>
            </div>
            <div class="div_key" style="left: 637px;">
                <img src="piano_Eb.jpg" class="key" data-note='Eb_high'>
            </div>
            <div class="div_key" style="left: 735px;">
                <img src="piano_Db.jpg" class="key" data-note='Gb_high'>
            </div>
            <div class="div_key" style="left: 785px;">
                <img src="piano_Db.jpg" class="key" data-note='Ab_high'>
            </div>
            <div class="div_key" style="left: 837px;">
                <img src="piano_Eb.jpg" class="key" data-note='Bb_high'>
            </div>
        </div>
    </div>
    <audio id="dummy_audio" src="dummy.mp3"></audio>
    <script>
        //각 건반의 오디오 객체를 미리 생성해서 audioMap에 저장
        const audioMap = {
            'F_low': new Audio('audio/F_low.mp3'),
            'G_low': new Audio('audio/G_low.mp3'),
            'A_low': new Audio('audio/A_low.mp3'),
            'B_low': new Audio('audio/B_low.mp3'),
            'C_middle': new Audio('audio/C_middle.mp3'),
            'D_middle': new Audio('audio/D_middle.mp3'),
            'E_middle': new Audio('audio/E_middle.mp3'),
            'F_middle': new Audio('audio/F_middle.mp3'),
            'G_middle': new Audio('audio/G_middle.mp3'),
            'A_middle': new Audio('audio/A_middle.mp3'),
            'B_middle': new Audio('audio/B_middle.mp3'),
            'C_high': new Audio('audio/C_high.mp3'),
            'D_high': new Audio('audio/D_high.mp3'),
            'E_high': new Audio('audio/E_high.mp3'),
            'F_high': new Audio('audio/F_high.mp3'),
            'G_high': new Audio('audio/G_high.mp3'),
            'A_high': new Audio('audio/A_high.mp3'),
            'Gb_low': new Audio('audio/Gb_low.mp3'),
            'Ab_low': new Audio('audio/Ab_low.mp3'),
            'Bb_low': new Audio('audio/Bb_low.mp3'),
            'Db_middle': new Audio('audio/Db_middle.mp3'),
            'Eb_middle': new Audio('audio/Eb_middle.mp3'),
            'Gb_middle': new Audio('audio/Gb_middle.mp3'),
            'Ab_middle': new Audio('audio/Ab_middle.mp3'),
            'Bb_middle': new Audio('audio/Bb_middle.mp3'),
            'Db_high': new Audio('audio/Db_high.mp3'),
            'Eb_high': new Audio('audio/Eb_high.mp3'),
            'Gb_high': new Audio('audio/Gb_high.mp3'),
            'Ab_high': new Audio('audio/Ab_high.mp3'),
            'Bb_high': new Audio('audio/Bb_high.mp3')
        };
        
        for (let note in audioMap)// 미리 오디오파일 불러옴 > 속도 향상
            audioMap[note].preload = "auto";
        
        const playingAudios = [];

        function playNote(note) {
            const audio = audioMap[note];
            if (!audio) return;

            if (window.forwardToParent) {
                // 부모에게만 전달하고 자식은 재생하지 않음
                window.parent.postMessage({
                    type: "forwardAudio",
                    src: audio.src
                }, "*");
            } else {
                const clone = audio.cloneNode();
                clone.play();

                playingAudios.push(clone);
                clone.addEventListener('ended', () => {
                    const idx = playingAudios.indexOf(clone);
                    if (idx !== -1) playingAudios.splice(idx, 1);
                });
            }
            const keyEl = document.querySelector(`.key[data-note="${note}"]`);
            if (keyEl) {
                keyEl.classList.add('active');
                setTimeout(() => keyEl.classList.remove('active'), 200);
            }
        }

        const keyMap = {//키보드 입력을 통해 재생하기 위한 배열
            //왼손
            'q': 'F_low',
            '2': 'Gb_low',
            'w': 'G_low',
            '3': 'Ab_low',
            'e': 'A_low',
            '4': 'Bb_low',
            'r': 'B_low',
            't': 'C_middle',
            '6': 'Db_middle',
            'y': 'D_middle',
            '7': 'Eb_middle',
            'u': 'E_middle',
            'i': 'F_middle',
            '9': 'Gb_middle',
            'o': 'G_middle',

            //오른손
            'd': 'Ab_middle',
            'c': 'A_middle',
            'f': 'Bb_middle',
            'v': 'B_middle',
            'b': 'C_high',
            'h': 'Db_high',
            'n': 'D_high',
            'j': 'Eb_high',
            'm': 'E_high',
            ',': 'F_high',
            'l': 'Gb_high',
            '.': 'G_high',
            ';': 'Ab_high',
            '/': 'A_high',
            '\'': 'Bb_high'
        };
        let pressedKeys = new Set();

        document.addEventListener('keydown', function(event) {
            const key = event.key.toLowerCase();
            if (pressedKeys.has(key)) return; // 이미 눌린 키는 무시
            pressedKeys.add(key);

            const note = keyMap[key];
            if (note) playNote(note);
        });

        document.addEventListener('keyup', function(event) {
            pressedKeys.delete(event.key.toLowerCase());
        });
        window.addEventListener("message", (event) => {
            if (event.data.type === "playDummyAudio") {
                const dummy = document.getElementById("dummy_audio");
                if (dummy) {
                    dummy.currentTime = 0;
                    dummy.play().catch(e => console.warn("dummy 재생 실패:", e));
                }
            }
            if (event.data.type === "sendContextInfo") {
                window.forwardToParent = true;
            }
        });
        document.querySelectorAll('.key').forEach(key => {
            const note = key.dataset.note; // data-note 값 추출
            if (!note) return;

            // PC용 클릭 이벤트
            key.addEventListener('click', () => playNote(note));

            // 모바일용 터치 이벤트
            key.addEventListener('touchstart', (e) => {
                e.preventDefault(); // 터치 후 클릭으로 이어지는 중복 방지
                playNote(note);
            });
        });
    </script>
</body>
</html>
